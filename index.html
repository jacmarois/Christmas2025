<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Downhill Sleigh</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #0b1d2a;
    overflow: hidden;
    font-family: system-ui, sans-serif;
    touch-action: none;
  }
  canvas {
    display: block;
    margin: auto;
    background: linear-gradient(#1c3b5a, #ffffff);
  }
</style>
</head>
<body>

<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

/* ---------- GLOBAL SCALE (MOBILE TUNING) ---------- */
const SCALE = 0.7;

/* ---------- GAME STATE ---------- */
let gameState = "title"; 
// title | playing | pausedImage | gameover

let score = 0;
let speed = 4;
let worldY = 0;

/* ---------- INPUT ---------- */
const keys = {};
let touchLeft = false;
let touchRight = false;

window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

canvas.addEventListener("touchstart", e => {
  for (let t of e.touches) {
    if (t.clientX < canvas.width / 2) touchLeft = true;
    else touchRight = true;
  }
});

canvas.addEventListener("touchend", () => {
  touchLeft = false;
  touchRight = false;
});

canvas.addEventListener("click", () => {
  if (gameState === "pausedImage") {
    gameState = "playing";
    return;
  }
  if (gameState !== "playing") startGame();
});

/* ---------- PLAYER ---------- */
const player = {
  x: canvas.width / 2,
  y: canvas.height * 0.72,
  vx: 0
};

/* ---------- OBJECTS ---------- */
let trees = [];
let gifts = [];

function rand(min, max) {
  return Math.random() * (max - min) + min;
}

/* ---------- IMAGES FOR PAUSE SCREENS ---------- */
const pauseImages = [];
const imageFiles = [
  "jelly-of-the-month.jpg",
  "buddy.jpg",
  "diehard.jpg",
  "killed-santa.jpg",
  "shitter.jpg"
];

imageFiles.forEach(name => {
  const img = new Image();
  img.src = `images/${name}`;
  pauseImages.push(img);
});

let imageIndex = 0;
let currentPauseImage = null;

/* ---------- RESET ---------- */
function startGame() {
  gameState = "playing";
  score = 0;
  speed = 4;
  worldY = 0;
  trees = [];
  gifts = [];
  imageIndex = 0;
  currentPauseImage = null;
  player.x = canvas.width / 2;
  player.vx = 0;
}

/* ---------- SPAWN ---------- */
function spawnObjects() {

  // Trees
  if (Math.random() < 0.035) {
    trees.push({
      x: rand(canvas.width * 0.22, canvas.width * 0.78),
      y: -120
    });
  }

  // Gifts
  if (Math.random() < 0.03) {
    gifts.push({
      x: rand(canvas.width * 0.26, canvas.width * 0.74),
      y: -80,
      color: `hsl(${rand(0,360)},70%,60%)`
    });
  }
}

/* ---------- DRAW PLAYER ---------- */
function drawPlayer() {
  ctx.save();
  ctx.translate(player.x, player.y);
  ctx.scale(SCALE, SCALE);
  ctx.rotate(0.05);

  // Sled
  ctx.fillStyle = "#7a3a1d";
  ctx.beginPath();
  ctx.roundRect(-36, 18, 72, 10, 6);
  ctx.fill();

  ctx.strokeStyle = "#4a1f0f";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(-28, 26);
  ctx.lineTo(-28, 40);
  ctx.moveTo(28, 26);
  ctx.lineTo(28, 40);
  ctx.stroke();

  // Body
  ctx.fillStyle = "#c0392b";
  ctx.beginPath();
  ctx.ellipse(0, 0, 16, 22, -0.2, 0, Math.PI * 2);
  ctx.fill();

  // Legs
  ctx.fillStyle = "#333";
  ctx.fillRect(-12, 16, 8, 12);
  ctx.fillRect(4, 16, 8, 12);

  // Head
  ctx.fillStyle = "#f1c27d";
  ctx.beginPath();
  ctx.arc(0, -28, 10, 0, Math.PI * 2);
  ctx.fill();

  // Hat
  ctx.fillStyle = "#b22222";
  ctx.beginPath();
  ctx.moveTo(-12, -32);
  ctx.lineTo(12, -32);
  ctx.lineTo(0, -48);
  ctx.closePath();
  ctx.fill();

  // Scarf
  ctx.strokeStyle = "#f1c40f";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(8, -6);
  ctx.lineTo(30 + Math.sin(worldY * 0.1) * 6, 6);
  ctx.moveTo(6, -4);
  ctx.lineTo(20 + Math.cos(worldY * 0.1) * 4, 14);
  ctx.stroke();

  ctx.restore();
}

/* ---------- DRAW OBJECTS ---------- */
function drawTree(t) {
  ctx.save();
  ctx.translate(t.x, t.y);
  ctx.scale(SCALE, SCALE);

  // Trunk
  ctx.fillStyle = "#6b3e26";
  ctx.fillRect(-10, 50, 20, 50);

  // Foliage
  ctx.fillStyle = "#1e7f3b";
  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(-44, 70);
  ctx.lineTo(44, 70);
  ctx.closePath();
  ctx.fill();

  ctx.restore();
}

function drawGift(g) {
  ctx.fillStyle = g.color;
  ctx.fillRect(g.x - 16, g.y - 16, 32, 32);
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(g.x, g.y - 16);
  ctx.lineTo(g.x, g.y + 16);
  ctx.moveTo(g.x - 16, g.y);
  ctx.lineTo(g.x + 16, g.y);
  ctx.stroke();
}

/* ---------- COLLISION ---------- */
function hit(a, bx, by, r) {
  const dx = a.x - bx;
  const dy = a.y - by;
  return Math.sqrt(dx*dx + dy*dy) < r;
}

/* ---------- UPDATE ---------- */
function update() {
  if (gameState !== "playing") return;

  worldY += speed;
  speed += 0.0006;

  if (keys["ArrowLeft"] || touchLeft) player.vx -= 0.8;
  if (keys["ArrowRight"] || touchRight) player.vx += 0.8;

  player.vx *= 0.86;
  player.x += player.vx;
  player.x = Math.max(120, Math.min(canvas.width - 120, player.x));

  spawnObjects();

  trees.forEach(t => t.y += speed);
  gifts.forEach(g => g.y += speed);

  for (let t of trees) {
    if (hit(player, t.x, t.y + 70 * SCALE, 30 * SCALE)) {
      gameState = "gameover";
    }
  }

  for (let i = gifts.length - 1; i >= 0; i--) {
    if (hit(player, gifts[i].x, gifts[i].y, 22)) {
      score++;
      gifts.splice(i, 1);

      if (score % 10 === 0 && pauseImages.length) {
        currentPauseImage = pauseImages[imageIndex % pauseImages.length];
        imageIndex++;
        gameState = "pausedImage";
      }
    }
  }
}

/* ---------- UI ---------- */
function drawPauseImage() {
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (!currentPauseImage) return;

  const maxW = canvas.width * 0.85;
  const maxH = canvas.height * 0.6;
  const scale = Math.min(
    maxW / currentPauseImage.width,
    maxH / currentPauseImage.height
  );

  const w = currentPauseImage.width * scale;
  const h = currentPauseImage.height * scale;

  ctx.drawImage(
    currentPauseImage,
    canvas.width / 2 - w / 2,
    canvas.height / 2 - h / 2,
    w,
    h
  );

  ctx.fillStyle = "#000";
  ctx.font = "20px sans-serif";
  ctx.fillText(
    "üéÅ 10 presents delivered ‚Äî tap to continue",
    canvas.width / 2 - 170,
    canvas.height / 2 + h / 2 + 40
  );
}

function drawUI() {
  ctx.fillStyle = "#000";
  ctx.font = "22px sans-serif";
  ctx.fillText("Presents: " + score, 20, 32);

  if (gameState === "title") {
    ctx.font = "42px sans-serif";
    ctx.fillText("Downhill Sleigh", canvas.width/2 - 160, canvas.height/2 - 90);

    ctx.font = "20px sans-serif";
    ctx.fillText("Collect presents üéÅ", canvas.width/2 - 100, canvas.height/2 - 20);
    ctx.fillText("Avoid trees üå≤", canvas.width/2 - 90, canvas.height/2 + 10);
    ctx.fillText("Tap left / right to steer", canvas.width/2 - 140, canvas.height/2 + 50);
    ctx.fillText("Tap to start", canvas.width/2 - 60, canvas.height/2 + 90);
  }

  if (gameState === "gameover") {
    ctx.font = "42px sans-serif";
    ctx.fillText("CRASH!", canvas.width/2 - 90, canvas.height/2 - 30);
    ctx.font = "20px sans-serif";
    ctx.fillText("Presents collected: " + score, canvas.width/2 - 120, canvas.height/2 + 10);
    ctx.fillText("Tap to try again", canvas.width/2 - 90, canvas.height/2 + 50);
  }
}

/* ---------- LOOP ---------- */
function loop() {
  update();
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  trees.forEach(drawTree);
  gifts.forEach(drawGift);

  if (gameState !== "title") drawPlayer();
  if (gameState === "pausedImage") drawPauseImage();

  drawUI();
  requestAnimationFrame(loop);
}
loop();
</script>

</body>
</html>
